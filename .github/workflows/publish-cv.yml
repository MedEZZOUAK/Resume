name: Publish CV PDFs to portfolio

on:
  workflow_dispatch:
  push:
    paths:
      - cv_frensh.tex
      - resume.tex
      - awesome-cv.cls
      - cv/**
      - resume/**
      - fonts/**
      - .github/workflows/publish-cv.yml

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout resume repo
        uses: actions/checkout@v4

      - name: Build PDFs with LaTeX
        uses: xu-cheng/latex-action@v3
        with:
          latexmk_use_xelatex: true
          args: -interaction=nonstopmode -file-line-error -outdir=build
          root_file: |
            cv_frensh.tex
            resume.tex

      - name: Checkout portfolio repo
        uses: actions/checkout@v4
        with:
          repository: MedEZZOUAK/me
          token: ${{ secrets.PORTFOLIO_REPO_TOKEN }}
          path: portfolio

      - name: Copy PDFs into portfolio public/
        run: |
          mkdir -p portfolio/public
          cp build/cv_frensh.pdf portfolio/public/cv_frensh.pdf
          cp build/resume.pdf portfolio/public/resume.pdf

      - name: Commit and push if changed
        working-directory: portfolio
        run: |
          git status --porcelain
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/cv_frensh.pdf public/resume.pdf
          git commit -m "Update CV PDFs"
          git push
